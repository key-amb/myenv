#!/usr/bin/env bash

set -euo pipefail

PROG=$(basename $0)

FORCE=
case "${1:-}" in
  "-f" | "--force" )
    FORCE=1
    ;;
  "" ) ;;
  * )
    echo "[info] Option $1 is ignored."
esac

TMPD=$HOME/tmp/$PROG
mkdir -p $TMPD
YMD=$(date +%Y%m%d)

if [[ $MYENV ]]; then
  shrc=$HOME/.myenv/envs/$MYENV/lib/$PROG.bashrc
  [[ -r $shrc ]] && . $shrc
fi

if [[ -z ${LOCAL_REPOS:-} ]]; then
  LOCAL_REPOS=($HOME/.myenv)
fi

for repo in ${LOCAL_REPOS[@]}; do
  repo_base=$(basename $repo)
  tsfile="$TMPD/${repo_base}.$YMD"
  [[ -z $FORCE && -e $tsfile ]] && continue
  cd $repo
  git pull origin master
  if [[ -f .gitmodules ]]; then
    git submodule update --init
  fi
  rm -f "$TMPD/${repo_base}.*"
  touch $tsfile
done

tsfile="$TMPD/clam-modules.$YMD"
if [[ $FORCE || ! -e $tsfile ]]; then
  clam -r $HOME/.myenv/common/Clamfile
  rm -f "$TMPD/clam-modules.*"
  touch $tsfile
fi

exit

: <<'__EOF__'

=encoding utf8

=head1 NAME

B<update-local-repos> - Update repositories

=head1 SYNOPSYS

    env MYENV=ubuntu-desktop update-local-repos [-f|--force]

=head1 DESCRIPTION

Update local repositories configured by C<LOCAL_REPOS> shell variable.

=head1 AUTHORS

IKEDA Kiyoshi E<lt>yasutake.kiyoshi@gmail.comE<gt>

=cut

__EOF__

